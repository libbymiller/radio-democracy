#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'
require 'radiodan'
require 'sinatra/async'
require 'thin'

$:<< './lib'
require "radiodan/playlist"
require 'random_channel'
require 'web_server'

root = File.join(File.dirname(__FILE__), '..')

vol = 70

channels = []

File.readlines(File.join(root, 'items')).each do |item|
  name = item.split(" ")[0]
  if(name)
    channels.push(name)
  end
end

require 'pp'
pp channels

channel = Radiodan::Playlist.new tracks: channels.sample, volume: vol

EM.synchrony do

  radio = Radiodan.new do |builder|
    builder.log      STDOUT
    builder.adapter  :MPD, :host => 'localhost', :port => 6600
    builder.playlist channel
    builder.use      :random_channel, :filename => "#{root}/items"
  end

  radio.start

  Thin::Server.start WebServer.new(radio.player,root), '0.0.0.0', 3000, :signals => false
end
