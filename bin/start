#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'
require 'radiodan'
require 'sinatra/async'
require 'thin'

$:<< './lib'
require "radiodan/playlist"
require 'change_channel'
require 'web_server'

root = File.join(File.dirname(__FILE__), '..')

vol = 70

channels = []

items = File.readlines(File.join(root, 'items'))
items.each do |item|
  channels.push(item.split(" ")[8])
end

channel = Radiodan::Playlist.new tracks: channels.sample

EM.synchrony do
  radios = Radiodan::Playlist.new(tracks: (channel))

  radio = Radiodan.new do |builder|
    builder.log      STDOUT
    builder.adapter  :MPD, :host => 'localhost', :port => 6600
    builder.playlist channel
    builder.use      :change_channel, :filename => "#{root}/items"
  end

  radio.start

  Thin::Server.start WebServer.new(radio.player), '0.0.0.0', 3000, :signals => false
end
